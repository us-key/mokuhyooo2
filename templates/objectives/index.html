{% extends "_base.html" %}
{% block content %}
{% load cmn_filter %}
<script type="text/javascript">
    $(function () {
        $("#block-content").removeClass("pad-top-56");
        $("#block-content").addClass("pad-top-96");
        moment.locale('ja', {
            week: {
                dow: 1
            }
        });
        $('#datetimepicker').datetimepicker({
            locale: 'ja',
            dayViewHeaderFormat: 'YYYY年 M月',
            format: 'YYYY-MM-DD'
        });
        $('#datetimepicker').val('{{display_date}}');
        $('#datetimepicker').on("change.datetimepicker", function(e){
            e.preventDefault();
            if (e.oldDate) {
                var target_date = $(this).val();
                window.location.href = "/objectives/display_date?target_date=" + target_date;    
            }
        });
        $('.modalOpener').on("click", function(e){
            e.preventDefault();
            // 処理前に Loading 画像を表示
            dispLoading("処理中...");

            // freeInput取得
            var input_unit = $(this).attr("id").split("_")[0];
            var input_kind = $(this).attr("id").split("_")[1];
            var date = $('#datetimepicker').val();
            var url = '/objectives/ajax/freeword/get';
            $.ajax({
                url: url,
                method: "GET",
                data: {
                    "input_unit": input_unit,
                    "input_kind": input_kind,
                    "input_date": date,
                    "user": {{user.id}}
                },
                timeout: 10000,
                datatype: "text",
            })
            .done(function(json){
                id = "";
                textarea_text = "";
                if (json.length>0) {
                    id = json[0].pk;
                    textarea_text = json[0].fields.free_word;
                }
                // aタグのid
                a_tag_id = input_unit + "_" + input_kind + "_link_" + id;
                $('.modal_link').attr('id', a_tag_id);
                $('.modal-textarea').val(textarea_text);
            })
            .always(function(){
                removeLoading();
            });
        })
        $(".fw_post").on("click", function(e){
            e.preventDefault();
            // 処理前に Loading 画像を表示
            dispLoading("処理中...");

            var free_word = $(this).parents(".objective-review-group").children(".objective-review-input").val();
            var date = $('#datetimepicker').val();
            var input_unit = $(this).attr("id").split("_")[0];
            var input_kind = $(this).attr("id").split("_")[1];
            var id = $(this).attr("id").split("_")[3];
            var url = $(this).prop("href");
            var token = '{{csrf_token}}';
            $.ajax({
                url: url,
                method: "POST",
                headers: { "X-CSRFToken": token },
                data: {
                    "id": id,
                    "input_unit": input_unit,
                    "input_kind": input_kind,
                    "free_word": free_word,
                    "input_date": date 
                },
                timeout: 10000,
                datatype: "text",
            })
            .done(function(msg){
                alert(msg);
                // TODO 登録完了メッセージをヘッダに出す
                // TODO 一旦リロードするが、他項目など登録していないと消えてしまうため、
                // 最終的にはajaxでid受け取って上書きするようにする。
                location.reload();
            })
            .always(function(){
                removeLoading();
            });
        });
        // 日の実績値を投げる
        $(".do_post").on("click", function(e){

            e.preventDefault();
            var target_date = $('#datetimepicker').val();
            // 実績値取得して投げる
            var outputs = [];
            var rows = $(".d_out_row");
            rows.each(function(idx, row){
                var obj = {};
                // id
                var id = $(row).attr("id").split("_")[1];
                // master_id あんまきれいな取り方ではないがとりあえず
                var master_id = $(row).attr("class").split("d_row_")[1];
                // 実績値
                var dom = $(row).find(".input_obj");
                var val = $(dom).val();
                var number_kind = $(dom).attr("id").split("_")[1];
                // 入力がある場合のみ登録
                if (val) {
                    if (number_kind != "N"){
                        // 時間の変換
                        val = parseInt(val.split(":")[0]) * 60 + parseInt(val.split(":")[1]) 
                    }
                    obj = {
                        "id": id,
                        "master_id": master_id,
                        "value": val
                    }
                    outputs.push(obj); 
                }
            });
            if (outputs.length == 0){
                $(".msg-area").text("実績の入力がありません。");
            } else {
                // 処理前に Loading 画像を表示
                dispLoading("処理中...");
                var token = '{{csrf_token}}';
                $.ajax({
                    url: "{% url 'objectives:ajax_dateoutput_create' %}",
                    method: "POST",
                    headers: { "X-CSRFToken": token },
                    dataType: "json",
                    data: JSON.stringify({
                        "target_date": target_date,
                        "outputs": outputs
                    }),
                    timeout: 10000,
                })
                .done(function(){
                    alert("実績登録完了")
                    location.reload();
                    // TODO 一旦リロードするが、他項目など登録していないと消えてしまうため、
                    // 最終的にはajaxでid受け取って上書きするようにする。
                })
                .always(function(){
                    removeLoading();
                });
            }
        });
        $("#btn_left").on("click", function(){
            var target_date = getCalculatedDateStr($('#datetimepicker').val(), -1);
            window.location.href = "/objectives/display_date?target_date=" + target_date;    
        });
        $("#btn_right").on("click", function(){
            var target_date = getCalculatedDateStr($('#datetimepicker').val(), 1);
            window.location.href = "/objectives/display_date?target_date=" + target_date;    
        })
    });
    function getCalculatedDateStr(target_date, calcDate) {
        var year = target_date.substr(0,4);
        var month = target_date.substr(5,2);
        var date = target_date.substr(8,2);
        var dt = new Date(year, month-1, date);
        dt.setDate(dt.getDate() + calcDate);
        return dt.getFullYear() + "-" + ("00" + (dt.getMonth()+1)).slice(-2) + "-" + ("00" + (dt.getDate())).slice(-2)
    }
</script>
<div class="row nav-date">
    <div class="col-1 btn btn-success" id="btn_left">＜</div>
    <div class="col-10">
        <input type="text" class="form-control datetimepicker-input"
                id="datetimepicker" data-toggle="datetimepicker"
                data-target="#datetimepicker"/>
    </div>
    <div class="col-1 btn btn-success" id="btn_right">＞</div>
</div>      
<!-- 目標・振返り作成状況によりメッセージ表示 -->
{% for k,v in objRevFlgList.items %}
    {% if k|obj_rev_msg_flg:v %}
    <div class="alert alert-warning alert-dismissable" role="alert">
        <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        {{ k|create_obj_rev_msg }}
        <a href="{{ k|create_obj_rev_link:display_date }}" class="alert-link">作成</a>
    </div>
    {% endif %}
{% endfor %}
<div class="row">
    <div class="col-6">
        <p>
            <i class="{{ objRevFlgList.TYO|get_checkbox }}"></i>
            <a href="{{ 'TYO'|create_obj_rev_link:display_date }}">年目標</a>
        </p>
        <p>
            <i class="{{ objRevFlgList.TMO|get_checkbox }}"></i>
            <a href="{{ 'TMO'|create_obj_rev_link:display_date }}">月目標</a>
        </p>
    </div>
    <div class="col-6">
        <p>
            <i class="{{ objRevFlgList.TYR|get_checkbox }}"></i>
            <a href="{{ 'TYR'|create_obj_rev_link:display_date }}">年振返り</a>
        </p>
        <p>
            <i class="{{ objRevFlgList.TMR|get_checkbox }}"></i>
            <a href="{{ 'TMR'|create_obj_rev_link:display_date }}">月振返り</a>
        </p>
        <p>
            <i class="{{ objRevFlgList.TWR|get_checkbox }}"></i>
            <a href="{{ 'TWR'|create_obj_rev_link:display_date }}">週振返り</a>
        </p>
    </div>
</div>
{% if weekFreeObjective %}
<div class="row">
    <div class="col-12">
        <div class="form-group objective-review-group">
            <label>今週の目標 
                <a href="{% url 'objectives:week_objective_edit' display_date %}">
                    <i class="fas fa-edit"></i>
                </a>
            </label>
            <textarea class='form-control objective-review-input' rows='6' readonly>{{ weekFreeObjective.free_word|default_if_none:"" }}</textarea>
        </div>
        <p>
        </p>
    </div>
</div>
<div class="row">
    <div class="col-md-6 col-12">
        <div class="form-group objective-review-group">
            <label>今日の目標 
                <a id="D_O_link_{{ dateFreeObjective.id|default_if_none:'' }}" href="{% url 'objectives:ajax_freeword_register' %}" class="fw_post">
                    <i class="fas fa-upload"></i>
                </a>
            </label>
            <textarea class='form-control objective-review-input' rows='2'>{{ dateFreeObjective.free_word|default_if_none:"" }}</textarea>
        </div>
        <div class="form-group objective-review-group">
            <label>今日の振返り 
                <a id="D_R_link_{{ dateFreeReview.id|default_if_none:'' }}" href="{% url 'objectives:ajax_freeword_register' %}" class="fw_post">
                    <i class="fas fa-upload"></i>
                </a>
            </label>
            <textarea class='form-control objective-review-input' rows='2'>{{ dateFreeReview.free_word|default_if_none:"" }}</textarea>
        </div>    
    </div>
    <div class="col-md-6 col-12">
        <div class="msg-area"></div>
        <table class="table table-hover">
          <thead>
            <tr>
              <th>数値目標</th>
              <th></th>
              <th></th>
              <th>今日の実績 <a href="#" class="do_post"><i class="fas fa-upload"></i></a></th>
              <th>進捗状況</th>
            </tr>
          </thead>
          <tbody>
            {% for numObj in numberObjective %}
            <tr class="d_out_row d_row_{{ numObj.masterid }}" id="row_{{ numObj.id|default_if_none:'' }}">
              <th scope="row">{{ numObj.name }}</th>
              <td>
              {% if numObj.summary_kind == 'S' %}
                週
              {% elif numObj.summary_kind == 'A' %}
                平均
              {% endif %}
              </td>
              {% if numObj.number_kind == 'N' %}
                {% include "objectives/_daily_output_number.html" %}
              {% elif numObj.number_kind == 'P' %}
                {% include "objectives/_daily_output_period.html" %}
              {% elif numObj.number_kind == 'T' %}
                {% include "objectives/_daily_output_time.html" %}
              {% endif %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
    </div>
</div>
{% else %}
<p>週の目標が設定されていません！</p><a href="{% url 'objectives:week_objective_create' display_date %}">設定する</a>
{% endif %}
<!-- modal -->
<div class="modal fade" id="freecommentmodal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-body">
                <div class="form-group objective-review-group">
                    <!-- 選択したリンクによりjsで構成 -->
                    <label class="modal-label"><!-- ラベル：可変設定 -->
                        <a href="{% url 'objectives:ajax_freeword_register' %}" class="fw_post modal_link">
                            <!-- aタグのid可変設定 -->
                            <i class="fas fa-upload"></i>
                        </a>
                    </label>
                    <textarea class='form-control objective-review-input modal-textarea' rows='6'></textarea>
                    <!-- テキストエリアの中身可変設定 -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
