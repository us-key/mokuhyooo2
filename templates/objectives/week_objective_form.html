{% extends "_base.html" %}
{% block content %}
<script type="text/javascript">
    $(function(){
        // 時刻・期間入力項目の入力制御(数値、コロンのみ)
        $("[with]").off(".inputcontrol")
        $("[with='time']")
            .off(".inputcontrol.time")
            .on("keyup.inputcontrol.time", function(){
                $(this).val($(this).val().replace(/[^0-9:]/g,""));
            })
        // 時刻・期間入力項目のフォーカスアウト時制御
        $(".input_pe, .input_ti").on("focusout", function(e){
            e.preventDefault();
            var str = $(this).val();
            var tmpInt = null;
            var outStr = "";
            var errMsg = ""; 
            if (str != "") {
                // 1. コロン無しの場合、時:分に変換
                if (str.indexOf(":") == -1) {
                    tmpInt = parseInt(str, 10);
                    str = (tmpInt / 60 | 0).toString() + ":" + ('00' + (tmpInt % 60)).slice(-2);
                }
                var strArr = str.split(":");
                // 2. コロン前後のチェック
                if (strArr[1].length > 2) {
                    errMsg = "xx:xxの形式で入力してください。"; // フォーマットエラー
                } else if ($(this).attr("class").indexOf("input_pe") != -1 && parseInt(strArr[0], 10) >= 24) {
                    // 期間 & 時≧24
                    errMsg = "期間は0:00~23:59の間で入力してください。"; // 期間オーバーエラー
                } else if ($(this).attr("class").indexOf("input_ti") != -1 && parseInt(strArr[0], 10) >= 48) {
                    // 時刻 & 時≧48
                    errMsg = "時刻は0:00~47:59の間で入力してください。"; // 時刻オーバーエラー
                }
                // 3. フォーマット
                if (errMsg == "") {
                    if (strArr[0] == "") strArr[0] = "0";
                    str = strArr[0] + ":" + ('00' + strArr[1]).slice(-2);
                    $(".msg-area").text("");
                    outStr = str
                } else {
                    $(".msg-area").text(errMsg);
                }
            }
            $(this).val(outStr);
        })
        // 入力値を投げる
        $("#wk_obj_submit").on("click", function(e){
            e.preventDefault();
            var path = location.pathname;
            var target_date = path.split("/")[4];
            var free_word = $(".objective-review-input").val();
            var objectives = [];
            var rows = $(".wk_obj_row");
            rows.each(function(idx, row){
                var obj = {};
                // id
                var id = $(row).attr("id").split("_")[1];
                // 目標値
                var dom = $(row).find(".input_obj");
                var val = $(dom).val();
                var number_kind = $(dom).attr("id").split("_")[1];
                // 入力がある場合のみ登録
                if (val) {
                    if (number_kind != "N"){
                        // 時間の変換
                        val = parseInt(val.split(":")[0]) * 60 + parseInt(val.split(":")[1]) 
                    }
                    obj = {
                        "master_id": id,
                        "value": val
                    }
                    objectives.push(obj); 
                }
            });
            if (objectives.length == 0){
                $(".msg-area").text("数値目標の入力がありません。");
            } else {
                var token = '{{csrf_token}}';
                $.ajax({
                    url: "{% url 'objectives:ajax_weekobj_create' %}",
                    method: "POST",
                    headers: { "X-CSRFToken": token },
                    dataType: "json",
                    data: JSON.stringify({
                        "target_date": target_date,
                        "free_word": free_word,
                        "objectives": objectives
                    }),
                    timeout: 10000,
                })
                .done(function(target_date){
                    console.log("週目標登録完了：" + target_data)
                    window.location.href = "{% url 'objectives:index' %}";
                })
            }
        })
    })
</script>
<h4>週の目標 ({{ start_date_str }} ~ {{ end_date_str }})</h4>
<div class="row">
    <!-- 自由入力 -->
    <div class="col-12">
        <div class="form-group objective-review-group">
            <textarea class='form-control objective-review-input' rows='6'>{{ weekFreeObjective.free_word|default_if_none:"" }}</textarea>
        </div>
    </div>
    <!-- 数値目標 -->
    <div class="col-4">数値目標</div>
    <div class="col-8 msg-area"></div>
</div>
<div class="row">
    <table class="table table-hover">
        <thead>
            <tr>
                <th></th>
                <th></th>
                <th>目標値</th>
                <th>前週実績</th> 
            </tr>
        </thead>
        <tbody>
        <!-- 数値目標マスタ件数分行を作る -->
        {% for master in masters %}
            <!-- 名称 -->
            <tr class="wk_obj_row" id="row_{{ master.id }}">
                <td>
                    {{ master.name }}
                </td>
                <!-- 集計単位 -->
                <td style="text-align: right">
                {% if master.summary_kind == 'S' %}
                    週
                {% elif master.summary_kind == 'A' %}
                    平均
                {% endif %}
                </td>
                <!-- number_kind毎に形式分け -->
                {% if master.number_kind == 'N' %}
                    {% include "objectives/_week_objective_number.html" %}
                {% elif master.number_kind == 'P' %}
                    {% include "objectives/_week_objective_period.html" %}
                {% elif master.number_kind == 'T' %}
                    {% include "objectives/_week_objective_time.html" %}     
                {% endif %}
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<div class="row">
    <input id="wk_obj_submit" type="submit" class="btn btn-primary" value="登録"/>
</div>
{% endblock %}
